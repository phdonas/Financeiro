rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function memberPath(householdId, uid) {
      return /databases/$(database)/documents/households/$(householdId)/members/$(uid);
    }

    function isMember(householdId) {
      return isSignedIn() && exists(memberPath(householdId, request.auth.uid));
    }

    function isActiveMember(householdId) {
      return isMember(householdId)
        && get(memberPath(householdId, request.auth.uid)).data.active == true;
    }

    function role(householdId) {
      return isActiveMember(householdId)
        ? get(memberPath(householdId, request.auth.uid)).data.role
        : null;
    }

    function isAdmin(householdId) {
      return role(householdId) == "ADMIN";
    }

    function canWrite(householdId) {
      return isAdmin(householdId) || role(householdId) == "EDITOR";
    }

    // -------------------- INVITES HELPERS --------------------
    function emailLower() {
      return isSignedIn() && request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : "";
    }

    function invitePath(householdId, emailLowerDoc) {
      return /databases/$(database)/documents/households/$(householdId)/invites/$(emailLowerDoc);
    }

    function hasPendingInvite(householdId) {
      return emailLower() != ""
        && exists(invitePath(householdId, emailLower()))
        && get(invitePath(householdId, emailLower())).data.status == "pending";
    }

    // -------------------- MEMBERSHIP --------------------
    // households/{householdId}/members/{uid}
    match /households/{householdId}/members/{uid} {

      // Leitura:
      // - o próprio usuário pode ler seu doc (para checar se tem acesso)
      // - ADMIN lê docs de membros
      allow get: if isSignedIn() && (request.auth.uid == uid || isAdmin(householdId));
      allow list: if isActiveMember(householdId) && isAdmin(householdId);

      // Criação:
      // - ADMIN cria membros
      // - Convidado cria o próprio membership ao aceitar convite (sprint 7.2)
      allow create: if
        (
          isActiveMember(householdId)
          && isAdmin(householdId)
          && request.resource.data.uid == uid
          && request.resource.data.householdId == householdId
          && request.resource.data.active == true
          && request.resource.data.role in ["ADMIN", "EDITOR", "LEITOR"]
        )
        || (
          isSignedIn()
          && request.auth.uid == uid
          && hasPendingInvite(householdId)
          && request.resource.data.uid == uid
          && request.resource.data.householdId == householdId
          && request.resource.data.active == true
          && request.resource.data.role == get(invitePath(householdId, emailLower())).data.role
          && request.resource.data.role in ["ADMIN", "EDITOR", "LEITOR"]
        );

      // Atualização:
      // - ADMIN atualiza qualquer membro
      // - o próprio usuário atualiza apenas campos "seguros" (nome/email)
      // Proteção: uid/householdId não podem mudar
      // Proteção: self não pode alterar role/active
      allow update: if isActiveMember(householdId)
        && (
          (isAdmin(householdId))
          || (
            request.auth.uid == uid
            && request.resource.data.role == resource.data.role
            && request.resource.data.active == resource.data.active
          )
        )
        && request.resource.data.uid == uid
        && request.resource.data.householdId == householdId;

      allow delete: if false;
    }

    // -------------------- INVITES --------------------
    // households/{householdId}/invites/{emailLowerDoc}
    match /households/{householdId}/invites/{emailLowerDoc} {
      // Leitura:
      // - ADMIN lê convites
      // - o próprio convidado pode ler o convite do seu e-mail (docId = emailLower)
      allow get: if isSignedIn() && (isAdmin(householdId) || emailLowerDoc == emailLower());
      allow list: if isActiveMember(householdId) && isAdmin(householdId);

      // Criação/Revogação:
      // - somente ADMIN cria/revoga convites (UI entra em sprint 7.3)
      allow create, delete: if isActiveMember(householdId) && isAdmin(householdId);

      // Update:
      // - ADMIN pode atualizar
      // - convidado pode apenas aceitar (pending -> accepted), alterando somente campos permitidos
      allow update: if
        (isActiveMember(householdId) && isAdmin(householdId))
        || (
          isSignedIn()
          && emailLowerDoc == emailLower()
          && resource.data.status == "pending"
          && request.resource.data.status == "accepted"
          && request.resource.data.acceptedByUid == request.auth.uid
          && request.resource.data.role == resource.data.role
          && request.resource.data.emailLower == resource.data.emailLower
          && request.resource.data.email == resource.data.email
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            "status", "acceptedAt", "acceptedByUid", "updatedAt"
          ])
        );
    }

    // -------------------- SETTINGS --------------------
    // Doc: households/{householdId}/settings/app
    match /households/{householdId}/settings/{docId} {
      allow read: if isActiveMember(householdId);
      allow write: if isAdmin(householdId);
    }

    // -------------------- SUBCOLEÇÕES DO HOUSEHOLD --------------------
    // Ex.: households/{householdId}/transacoes/{id}
    //      households/{householdId}/categorias/{id}
    match /households/{householdId}/{subcollection}/{docId} {
      allow read: if isActiveMember(householdId);
      allow create, update, delete: if canWrite(householdId);
    }

    // Bloqueia qualquer outra coleção fora do padrão acima
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
