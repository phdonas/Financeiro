rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isHouseholdMember(householdId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/households/$(householdId)/members/$(request.auth.uid));
    }

    // --- Membership ---
    // Bootstrap seguro: o próprio usuário pode criar/ler/atualizar seu doc de membership.
    match /households/{householdId}/members/{uid} {
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow update: if isSignedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    // --- Settings ---
    // Doc: households/{householdId}/settings/app
    match /households/{householdId}/settings/{docId} {
      allow read, write: if isHouseholdMember(householdId);
    }

    // --- Subcoleções do household ---
    // Ex.: households/{householdId}/transacoes/{id}
    //      households/{householdId}/categorias/{id}
    match /households/{householdId}/{subcollection}/{docId} {
      allow read, write: if isHouseholdMember(householdId);
    }

    // (Opcional) Bloqueia qualquer outra coleção fora do padrão acima
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
