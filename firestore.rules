rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function memberPath(householdId, uid) {
      return /databases/$(database)/documents/households/$(householdId)/members/$(uid);
    }

    function isMember(householdId) {
      return isSignedIn() && exists(memberPath(householdId, request.auth.uid));
    }

    function isActiveMember(householdId) {
      return isMember(householdId)
        && get(memberPath(householdId, request.auth.uid)).data.active == true;
    }

    function role(householdId) {
      return isActiveMember(householdId)
        ? get(memberPath(householdId, request.auth.uid)).data.role
        : null;
    }

    function isAdmin(householdId) {
      return role(householdId) == "ADMIN";
    }

    function canWrite(householdId) {
      return isAdmin(householdId) || role(householdId) == "EDITOR";
    }

    // -------------------- MEMBERSHIP --------------------
    // households/{householdId}/members/{uid}
    match /households/{householdId}/members/{uid} {

      // Leitura:
      // - o próprio usuário pode ler seu doc (para checar se tem acesso)
      // - ADMIN lê docs de membros
      allow get: if isSignedIn() && (request.auth.uid == uid || isAdmin(householdId));
      allow list: if isActiveMember(householdId) && isAdmin(householdId);

      // Criação:
      // - apenas ADMIN cria membros (invite-only entra em sprint 7.2)
      allow create: if isActiveMember(householdId)
        && isAdmin(householdId)
        && request.resource.data.uid == uid
        && request.resource.data.householdId == householdId
        && request.resource.data.active == true
        && request.resource.data.role in ["ADMIN", "EDITOR", "LEITOR"];

      // Atualização:
      // - ADMIN atualiza qualquer membro
      // - o próprio usuário atualiza apenas campos "seguros" (nome/email)
      // Proteção: uid/householdId não podem mudar
      // Proteção: self não pode alterar role/active
      allow update: if isActiveMember(householdId)
        && (
          (isAdmin(householdId))
          || (
            request.auth.uid == uid
            && request.resource.data.role == resource.data.role
            && request.resource.data.active == resource.data.active
          )
        )
        && request.resource.data.uid == uid
        && request.resource.data.householdId == householdId;

      allow delete: if false;
    }

    // -------------------- SETTINGS --------------------
    // Doc: households/{householdId}/settings/app
    match /households/{householdId}/settings/{docId} {
      allow read: if isActiveMember(householdId);
      allow write: if isAdmin(householdId);
    }

    // -------------------- SUBCOLEÇÕES DO HOUSEHOLD --------------------
    // Ex.: households/{householdId}/transacoes/{id}
    //      households/{householdId}/categorias/{id}
    match /households/{householdId}/{subcollection}/{docId} {
      allow read: if isActiveMember(householdId);
      allow create, update, delete: if canWrite(householdId);
    }

    // Bloqueia qualquer outra coleção fora do padrão acima
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
